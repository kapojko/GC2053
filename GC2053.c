#include "GC2053.h"

#define GC2053_REG_END		0xff
#define GC2053_REG_DELAY	0x00
#define GC2053_SUPPORT_40FPS_MIPI_SCLK (99000000)
#define GC2053_SUPPORT_30FPS_MIPI_SCLK (78000000)
#define GC2053_SUPPORT_25FPS_MIPI_SCLK (72000000)
#define GC2053_SUPPORT_15FPS_MIPI_SCLK (39000000)
#define GC2053_SUPPORT_30FPS_DVP_SCLK (74250000)
#define GC2053_SUPPORT_15FPS_DVP_SCLK (37125000)
#define SENSOR_OUTPUT_MAX_FPS 40
#define SENSOR_OUTPUT_MIN_FPS 5
#define SENSOR_VERSION	"H20230726a"

#define GC2053_MAX_AGAIN 444864

typedef enum {
    TX_SENSOR_MAX_FPS_120 = 120,
    TX_SENSOR_MAX_FPS_110 = 110,
    TX_SENSOR_MAX_FPS_100 = 100,
    TX_SENSOR_MAX_FPS_90 = 90,
    TX_SENSOR_MAX_FPS_80 = 80,
    TX_SENSOR_MAX_FPS_70 = 70,
    TX_SENSOR_MAX_FPS_60 = 60,
    TX_SENSOR_MAX_FPS_50 = 50,
    TX_SENSOR_MAX_FPS_45 = 45,
    TX_SENSOR_MAX_FPS_40 = 30,
    TX_SENSOR_MAX_FPS_30 = 30,
    TX_SENSOR_MAX_FPS_25 = 25,
    TX_SENSOR_MAX_FPS_20 = 20,
    TX_SENSOR_MAX_FPS_15 = 15,
    TX_SENSOR_MAX_FPS_12 = 12,
    TX_SENSOR_MAX_FPS_10 = 10,
    TX_SENSOR_MAX_FPS_5 = 5,
} sensor_max_fps_mode;

static unsigned char vts0 = 0x05;
static unsigned char vts1 = 0x8a;
static unsigned char vtsn0 = 0x05;
static unsigned char vtsn1 = 0x8a;

struct regval_list {
    unsigned char reg_num;
    unsigned char value;
};

/*
 * the part of driver maybe modify about different sensor and different board.
 */
struct again_lut {
    int index;
    unsigned int regb4;
    unsigned int regb3;
    unsigned int dpc;
    unsigned int blc;
    unsigned int gain;
};

struct again_lut gc2053_again_lut[] = {
    //inx, 0xb4 0xb3 0xb8 0xb9 gain
    {0x0, 0x0, 0x0, 0x1, 0x0, 0},                //  1.000000
    {0x1, 0x0, 0x10, 0x1, 0xc, 13726},           //  1.156250
    {0x2, 0x0, 0x20, 0x1, 0x1b, 31177},          //   1.390625
    {0x3, 0x0, 0x30, 0x1, 0x2c, 44067},          //   1.593750
    {0x4, 0x0, 0x40, 0x1, 0x3f, 64793},          //   1.984375
    {0x5, 0x0, 0x50, 0x2, 0x16, 78621},          //   2.296875
    {0x6, 0x0, 0x60, 0x2, 0x35, 96180},          //   2.765625
    {0x7, 0x0, 0x70, 0x3, 0x16, 109138},         //    3.171875
    {0x8, 0x0, 0x80, 0x4, 0x2, 132537},          //   4.062500
    {0x9, 0x0, 0x90, 0x4, 0x31, 146067},         //    4.687500
    {0xa, 0x0, 0xa0, 0x5, 0x32, 163567},         //    5.640625
    {0xb, 0x0, 0xb0, 0x6, 0x35, 176747},         //    6.484375
    {0xc, 0x0, 0xc0, 0x8, 0x4, 195118},          //   7.875000
    {0xd, 0x0, 0x5a, 0x9, 0x19, 208560},         //    9.078125
    {0xe, 0x0, 0x83, 0xb, 0xf, 229103},          //   11.281250
    {0xf, 0x0, 0x93, 0xd, 0x12, 242511},         //    13.000000
    {0x10, 0x0, 0x84, 0x10, 0x0, 262419},        //     16.046875
    {0x11, 0x0, 0x94, 0x12, 0x3a, 275710},       //      18.468750
    {0x12, 0x1, 0x2c, 0x1a, 0x2, 292252},        //     22.000000
    {0x13, 0x1, 0x3c, 0x1b, 0x20, 305571},       //      25.328125
    {0x14, 0x0, 0x8c, 0x20, 0xf, 324962},        //     31.093750
    {0x15, 0x0, 0x9c, 0x26, 0x7, 338280},        //     35.796875
    {0x16, 0x2, 0x64, 0x36, 0x21, 358923},       //      44.531250
    {0x17, 0x2, 0x74, 0x37, 0x3a, 372267},       //      51.281250
    {0x18, 0x0, 0xc6, 0x3d, 0x2, 392101},        //     63.250000
    {0x19, 0x0, 0xdc, 0x3f, 0x3f, 415415},       //      80.937500
    {0x1a, 0x2, 0x85, 0x3f, 0x3f, 421082},       //      85.937500
    {0x1b, 0x2, 0x95, 0x3f, 0x3f, 440360},       //      105.375000
    {0x1c, 0x0, 0xce, 0x3f, 0x3f, 444864},       //      110.515625
};

#if 0
struct tx_isp_sensor_attribute gc2053_attr = {
    .name = "gc2053",
    .chip_id = 0x2053,
    .cbus_type = TX_SENSOR_CONTROL_INTERFACE_I2C,
    .cbus_mask = V4L2_SBUS_MASK_SAMPLE_8BITS | V4L2_SBUS_MASK_ADDR_8BITS,
    .cbus_device = 0x37,
    .dbus_type = TX_SENSOR_DATA_INTERFACE_DVP,
    .dvp = {
        .mode = SENSOR_DVP_HREF_MODE,
        .blanking = {
            .vblanking = 0,
            .hblanking = 0,
        },
        .dvp_hcomp_en = 0,
    },
    .data_type = TX_SENSOR_DATA_TYPE_LINEAR,
    .max_again = 444864,
    .max_dgain = 0,
    .min_integration_time = 1,
    .min_integration_time_native = 4,
    .max_integration_time_native = 0x58a - 8,
    .integration_time_limit = 0x58a - 8,
    .total_width = 0x44c * 2,
    .total_height = 0x58a,
    .max_integration_time = 0x58a - 8,
    .integration_time_apply_delay = 2,
    .again_apply_delay = 2,
    .dgain_apply_delay = 2,
    .sensor_ctrl.alloc_again = gc2053_alloc_again,
    .sensor_ctrl.alloc_dgain = gc2053_alloc_dgain,
    .one_line_expr_in_us = 28,
    //	void priv; /* point to struct tx_isp_sensor_board_info */
};
#endif

unsigned int gc2053_alloc_again(unsigned int isp_gain, unsigned char shift, unsigned int *sensor_again)
{
    struct again_lut *lut = gc2053_again_lut;

    while (lut->gain <= GC2053_MAX_AGAIN) {
        if (isp_gain == 0) {
            *sensor_again = lut[0].index;
            return lut[0].gain;
        } else if (isp_gain < lut->gain) {
            *sensor_again = (lut - 1)->index;
            return (lut - 1)->gain;
        } else {
            if ((lut->gain == GC2053_MAX_AGAIN) && (isp_gain >= lut->gain)) {
                *sensor_again = lut->index;
                return lut->gain;
            }
        }

        lut++;
    }

    return isp_gain;
}

unsigned int gc2053_alloc_dgain(unsigned int isp_gain, unsigned char shift, unsigned int *sensor_dgain)
{
    return 0;
}

#if 0
struct tx_isp_mipi_bus gc2053_mipi = {
    .mode = SENSOR_MIPI_OTHER_MODE,
    .clk = 600,
    .lans = 2,
    .settle_time_apative_en = 1,
    .mipi_sc.sensor_csi_fmt = TX_SENSOR_RAW10,//RAW10
    .mipi_sc.hcrop_diff_en = 0,
    .mipi_sc.mipi_vcomp_en = 0,
    .mipi_sc.mipi_hcomp_en = 0,
    .image_twidth = 1920,
    .image_theight = 1080,
    .mipi_sc.mipi_crop_start0x = 0,
    .mipi_sc.mipi_crop_start0y = 0,
    .mipi_sc.mipi_crop_start1x = 0,
    .mipi_sc.mipi_crop_start1y = 0,
    .mipi_sc.mipi_crop_start2x = 0,
    .mipi_sc.mipi_crop_start2y = 0,
    .mipi_sc.mipi_crop_start3x = 0,
    .mipi_sc.mipi_crop_start3y = 0,
    .mipi_sc.line_sync_mode = 0,
    .mipi_sc.work_start_flag = 0,
    .mipi_sc.data_type_en = 0,
    .mipi_sc.data_type_value = 0,
    .mipi_sc.del_start = 0,
    .mipi_sc.sensor_frame_mode = TX_SENSOR_DEFAULT_FRAME_MODE,
    .mipi_sc.sensor_fid_mode = 0,
    .mipi_sc.sensor_mode = TX_SENSOR_DEFAULT_MODE,
};

struct tx_isp_dvp_bus gc2053_dvp = {
    .mode = SENSOR_DVP_HREF_MODE,
    .blanking = {
        .vblanking = 0,
        .hblanking = 0,
    },
    .dvp_hcomp_en = 0,
};
#endif

static struct regval_list gc2053_init_regs_1920_1080_30fps_mipi[] = {
    //mclk=24mhz,mipi data rate=624mbps/lane
    //wpclk=156mhz,row_time=28.2us frame length=1418,25fps
    /*system*/
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x00},
    {0xf2, 0x00},
    {0xf3, 0x00},
    {0xf4, 0x36},
    {0xf5, 0xc0},
    {0xf6, 0x44},
    {0xf7, 0x01},
    {0xf8, 0x68},
    {0xf9, 0x40},
    {0xfc, 0x8e},
    /*CISCTL & ANALOG*/
    {0xfe, 0x00},
    {0x87, 0x18},
    {0xee, 0x30},
    {0xd0, 0xb7},
    {0x03, 0x04},
    {0x04, 0x60},
    {0x05, 0x04},
    {0x06, 0x4c},
    {0x07, 0x00},
    {0x08, 0x11},
    {0x09, 0x00},
    {0x0a, 0x02},
    {0x0b, 0x00},
    {0x0c, 0x02},
    {0x0d, 0x04},
    {0x0e, 0x40},
    {0x12, 0xe2},
    {0x13, 0x16},
    {0x19, 0x0a},
    {0x21, 0x1c},
    {0x28, 0x0a},
    {0x29, 0x24},
    {0x2b, 0x04},
    {0x32, 0xf8},
    {0x37, 0x03},
    {0x39, 0x15},
    {0x43, 0x07},
    {0x44, 0x40},
    {0x46, 0x0b},
    {0x4b, 0x20},
    {0x4e, 0x08},
    {0x55, 0x20},
    {0x66, 0x05},
    {0x67, 0x05},
    {0x77, 0x01},
    {0x78, 0x00},
    {0x7c, 0x93},
    {0x8c, 0x12},
    {0x8d, 0x92},
    {0x90, 0x00},/*use frame length to change fps*/
    {0x41, 0x04},
    {0x42, 0x9d},/*vts for 30fps mipi*/
    {0x9d, 0x10},
    {0xce, 0x7c},
    {0xd2, 0x41},
    {0xd3, 0xdc},
    {0xe6, 0x50},
    /*gain*/
    {0xb6, 0xc0},
    {0xb0, 0x70},
    {0xb1, 0x01},
    {0xb2, 0x00},
    {0xb3, 0x00},
    {0xb4, 0x00},
    {0xb8, 0x01},
    {0xb9, 0x00},
    /*blk*/
    {0x26, 0x30},
    {0xfe, 0x01},
    {0x40, 0x23},
    {0x55, 0x07},
    {0x60, 0x40},
    {0xfe, 0x04},
    {0x14, 0x78},
    {0x15, 0x78},
    {0x16, 0x78},
    {0x17, 0x78},
    /*window*/
    {0xfe, 0x01},
    {0x92, 0x00},
    {0x94, 0x03},
    {0x95, 0x04},
    {0x96, 0x38},
    {0x97, 0x07},
    {0x98, 0x80},
    /*ISP*/
    {0xfe, 0x01},
    {0x01, 0x05},
    {0x02, 0x89},
    {0x04, 0x01},
    {0x07, 0xa6},
    {0x08, 0xa9},
    {0x09, 0xa8},
    {0x0a, 0xa7},
    {0x0b, 0xff},
    {0x0c, 0xff},
    {0x0f, 0x00},
    {0x50, 0x1c},
    {0x89, 0x03},
    {0xfe, 0x04},
    {0x28, 0x86},
    {0x29, 0x86},
    {0x2a, 0x86},
    {0x2b, 0x68},
    {0x2c, 0x68},
    {0x2d, 0x68},
    {0x2e, 0x68},
    {0x2f, 0x68},
    {0x30, 0x4f},
    {0x31, 0x68},
    {0x32, 0x67},
    {0x33, 0x66},
    {0x34, 0x66},
    {0x35, 0x66},
    {0x36, 0x66},
    {0x37, 0x66},
    {0x38, 0x62},
    {0x39, 0x62},
    {0x3a, 0x62},
    {0x3b, 0x62},
    {0x3c, 0x62},
    {0x3d, 0x62},
    {0x3e, 0x62},
    {0x3f, 0x62},
    /****DVP & MIPI****/
    {0xfe, 0x01},
    {0x9a, 0x06},
    {0xfe, 0x00},
    {0x7b, 0x2a},
    {0x23, 0x2d},
    {0xfe, 0x03},
    {0x01, 0x27},
    {0x02, 0x56},
    {0x03, 0x8e},/*0xb6*/
    {0x12, 0x80},
    {0x13, 0x07},
    {0x15, 0x12},
    {0xfe, 0x00},
    {0x3e, 0x91},

    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_init_regs_1920_1080_25fps_mipi[] = {
    /****system****/
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x00},
    {0xf2, 0x00},
    {0xf3, 0x00},
    {0xf4, 0x36},
    {0xf5, 0xc0},
    {0xf6, 0x84},
    {0xf7, 0x11},
    {0xf8, 0x3c},
    {0xf9, 0x82},
    {0xfc, 0x8e},
    /****CISCTL & ANALOG****/
    {0xfe, 0x00},
    {0x87, 0x18},
    {0xee, 0x30},
    {0xd0, 0xb7},
    {0x03, 0x04},
    {0x04, 0x60},
    {0x05, 0x04},
    {0x06, 0x4c},
    {0x07, 0x00},
    {0x08, 0x11},
    {0x09, 0x00},
    {0x0a, 0x02},
    {0x0b, 0x00},
    {0x0c, 0x02},
    {0x0d, 0x04},
    {0x0e, 0x40},
    {0x12, 0xe2},
    {0x13, 0x16},
    {0x19, 0x0a},
    {0x21, 0x1c},
    {0x28, 0x0a},
    {0x29, 0x24},
    {0x2b, 0x04},
    {0x32, 0xf8},
    {0x37, 0x03},
    {0x39, 0x15},
    {0x43, 0x07},
    {0x44, 0x40},
    {0x46, 0x0b},
    {0x4b, 0x20},
    {0x4e, 0x08},
    {0x55, 0x20},
    {0x66, 0x05},
    {0x67, 0x05},
    {0x77, 0x01},
    {0x78, 0x00},
    {0x7c, 0x93},
    {0x8c, 0x12},
    {0x8d, 0x92},
    {0x90, 0x00},
    {0x41, 0x05},
    {0x42, 0x1c},
    {0x9d, 0x10},
    {0xce, 0x7c},
    {0xd2, 0x41},
    {0xd3, 0xdc},
    {0xe6, 0x50},
    /*gain*/
    {0xb6, 0xc0},
    {0xb0, 0x70},
    {0xb1, 0x01},
    {0xb2, 0x00},
    {0xb3, 0x00},
    {0xb4, 0x00},
    {0xb8, 0x01},
    {0xb9, 0x00},
    /*blk*/
    {0x26, 0x30},
    {0xfe, 0x01},
    {0x40, 0x23},
    {0x55, 0x07},
    {0x60, 0x40},
    {0xfe, 0x04},
    {0x14, 0x78},
    {0x15, 0x78},
    {0x16, 0x78},
    {0x17, 0x78},
    /*window*/
    {0xfe, 0x01},
    {0x92, 0x00},
    {0x94, 0x03},
    {0x95, 0x04},
    {0x96, 0x38},
    {0x97, 0x07},
    {0x98, 0x80},
    /*ISP*/
    {0xfe, 0x01},
    {0x01, 0x05},
    {0x02, 0x89},
    {0x04, 0x01},
    {0x07, 0xa6},
    {0x08, 0xa9},
    {0x09, 0xa8},
    {0x0a, 0xa7},
    {0x0b, 0xff},
    {0x0c, 0xff},
    {0x0f, 0x00},
    {0x50, 0x1c},
    {0x89, 0x03},
    {0xfe, 0x04},
    {0x28, 0x86},
    {0x29, 0x86},
    {0x2a, 0x86},
    {0x2b, 0x68},
    {0x2c, 0x68},
    {0x2d, 0x68},
    {0x2e, 0x68},
    {0x2f, 0x68},
    {0x30, 0x4f},
    {0x31, 0x68},
    {0x32, 0x67},
    {0x33, 0x66},
    {0x34, 0x66},
    {0x35, 0x66},
    {0x36, 0x66},
    {0x37, 0x66},
    {0x38, 0x62},
    {0x39, 0x62},
    {0x3a, 0x62},
    {0x3b, 0x62},
    {0x3c, 0x62},
    {0x3d, 0x62},
    {0x3e, 0x62},
    {0x3f, 0x62},
    /****DVP & MIPI****/
    {0xfe, 0x01},
    {0x9a, 0x06},
    {0xfe, 0x00},
    {0x7b, 0x2a},
    {0x23, 0x2d},
    {0xfe, 0x03},
    {0x01, 0x27},
    {0x02, 0x56},
    {0x03, 0xb6},
    {0x12, 0x80},
    {0x13, 0x07},
    {0x15, 0x10},
    {0xfe, 0x00},
    {0x3e, 0x91},

    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_init_regs_1920_1080_15fps_mipi[] = {
    //mclk=24mhz,mipi data rate=312mbps/lane
    //wpclk=156mhz,row_time=56.4us frame length=1418,15fps
    /*system*/
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x00},
    {0xf2, 0x00},
    {0xf3, 0x00},
    {0xf4, 0x36},
    {0xf5, 0xc0},
    {0xf6, 0x44},
    {0xf7, 0x03},
    {0xf8, 0x68},
    {0xf9, 0x40},
    {0xfc, 0x8e},
    /*CISCTL & ANALOG*/
    {0xfe, 0x00},
    {0x87, 0x18},
    {0xee, 0x30},
    {0xd0, 0xb7},
    {0x03, 0x04},
    {0x04, 0x60},
    {0x05, 0x04},
    {0x06, 0x4c},
    {0x07, 0x00},
    {0x08, 0x11},
    {0x09, 0x00},
    {0x0a, 0x02},
    {0x0b, 0x00},
    {0x0c, 0x02},
    {0x0d, 0x04},
    {0x0e, 0x40},
    {0x12, 0xe2},
    {0x13, 0x16},
    {0x19, 0x0a},
    {0x21, 0x1c},
    {0x28, 0x0a},
    {0x29, 0x24},
    {0x2b, 0x04},
    {0x32, 0xf8},
    {0x37, 0x03},
    {0x39, 0x15},
    {0x43, 0x07},
    {0x44, 0x40},
    {0x46, 0x0b},
    {0x4b, 0x20},
    {0x4e, 0x08},
    {0x55, 0x20},
    {0x66, 0x05},
    {0x67, 0x05},
    {0x77, 0x01},
    {0x78, 0x00},
    {0x7c, 0x93},
    {0x8c, 0x12},
    {0x8d, 0x92},
    {0x90, 0x00},/*use frame length to change fps*/
    {0x41, 0x04},
    {0x42, 0x9d},/*vts for max 15fps mipi*/
    {0x9d, 0x10},
    {0xce, 0x7c},
    {0xd2, 0x41},
    {0xd3, 0xdc},
    {0xe6, 0x50},
    /*gain*/
    {0xb6, 0xc0},
    {0xb0, 0x70},
    {0xb1, 0x01},
    {0xb2, 0x00},
    {0xb3, 0x00},
    {0xb4, 0x00},
    {0xb8, 0x01},
    {0xb9, 0x00},
    /*blk*/
    {0x26, 0x30},
    {0xfe, 0x01},
    {0x40, 0x23},
    {0x55, 0x07},
    {0x60, 0x40},
    {0xfe, 0x04},
    {0x14, 0x78},
    {0x15, 0x78},
    {0x16, 0x78},
    {0x17, 0x78},
    /*window*/
    {0xfe, 0x01},
    {0x92, 0x00},
    {0x94, 0x03},
    {0x95, 0x04},
    {0x96, 0x38},
    {0x97, 0x07},
    {0x98, 0x80},
    /*ISP*/
    {0xfe, 0x01},
    {0x01, 0x05},
    {0x02, 0x89},
    {0x04, 0x01},
    {0x07, 0xa6},
    {0x08, 0xa9},
    {0x09, 0xa8},
    {0x0a, 0xa7},
    {0x0b, 0xff},
    {0x0c, 0xff},
    {0x0f, 0x00},
    {0x50, 0x1c},
    {0x89, 0x03},
    {0xfe, 0x04},
    {0x28, 0x86},
    {0x29, 0x86},
    {0x2a, 0x86},
    {0x2b, 0x68},
    {0x2c, 0x68},
    {0x2d, 0x68},
    {0x2e, 0x68},
    {0x2f, 0x68},
    {0x30, 0x4f},
    {0x31, 0x68},
    {0x32, 0x67},
    {0x33, 0x66},
    {0x34, 0x66},
    {0x35, 0x66},
    {0x36, 0x66},
    {0x37, 0x66},
    {0x38, 0x62},
    {0x39, 0x62},
    {0x3a, 0x62},
    {0x3b, 0x62},
    {0x3c, 0x62},
    {0x3d, 0x62},
    {0x3e, 0x62},
    {0x3f, 0x62},
    /****DVP & MIPI****/
    {0xfe, 0x01},
    {0x9a, 0x06},
    {0xfe, 0x00},
    {0x7b, 0x2a},
    {0x23, 0x2d},
    {0xfe, 0x03},
    {0x01, 0x27},
    {0x02, 0x56},
    {0x03, 0x8e},/*0xb6*/
    {0x12, 0x80},
    {0x13, 0x07},
    {0x15, 0x12},
    {0xfe, 0x00},
    {0x3e, 0x91},

    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_init_regs_1920_1080_30fps_dvp[] = {
    /****system****/
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x00},
    {0xf2, 0x00},
    {0xf3, 0x0f},
    {0xf4, 0x36},
    {0xf5, 0xc0},
    {0xf6, 0x44},
    {0xf7, 0x01},
    {0xf8, 0x63},
    {0xf9, 0x40},
    {0xfc, 0x8e},
    /****CISCTL & ANALOG****/
    {0xfe, 0x00},
    {0x87, 0x18},
    {0xee, 0x30},
    {0xd0, 0xb7},
    {0x03, 0x04},
    {0x04, 0x60},
    {0x05, 0x04},
    {0x06, 0x4c},
    {0x07, 0x00},
    {0x08, 0x11},
    {0x09, 0x00},
    {0x0a, 0x02},
    {0x0b, 0x00},
    {0x0c, 0x02},
    {0x0d, 0x04},
    {0x0e, 0x40},
    {0x12, 0xe2},
    {0x13, 0x16},
    {0x19, 0x0a},
    {0x21, 0x1c},
    {0x28, 0x0a},
    {0x29, 0x24},
    {0x2b, 0x04},
    {0x32, 0xf8},
    {0x37, 0x03},
    {0x39, 0x15},
    {0x43, 0x07},
    {0x44, 0x40},
    {0x46, 0x0b},
    {0x4b, 0x20},
    {0x4e, 0x08},
    {0x55, 0x20},
    {0x66, 0x05},
    {0x67, 0x05},
    {0x77, 0x01},
    {0x78, 0x00},
    {0x7c, 0x93},
    {0x8c, 0x12},
    {0x8d, 0x92},
    {0x90, 0x00},/*use frame length to change fps*/
    {0x41, 0x05},
    {0x42, 0x46},/*vts for 25fps*/
    {0x9d, 0x10},
    {0xce, 0x7c},
    {0xd2, 0x41},
    {0xd3, 0xdc},
    {0xe6, 0x50},
    /*gain*/
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},
    /*blk*/
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},
    /*window*/
    {0xfe,0x01},
    {0x92,0x00},
    {0x94,0x03},
    {0x95,0x04},
    {0x96,0x38},
    {0x97,0x07},
    {0x98,0x80},
    /*ISP*/
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x01},
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x04},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},
    /****DVP & MIPI****/
    {0xfe,0x01},
    {0x9a,0x06},
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x20},
    {0x02,0x56},
    {0x03,0xb2},
    {0x12,0x80},
    {0x13,0x07},
    {0xfe,0x00},
    {0x3e,0x40},

    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_init_regs_1920_1080_15fps_dvp[] = {
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x80},
    {0xfe, 0x00},
    {0xf2, 0x00},
    {0xf3, 0x0f},
    {0xf4, 0x36},
    {0xf5, 0xc0},
    {0xf6, 0x44},
    {0xf7, 0x03},
    {0xf8, 0x63},
    {0xf9, 0x40},
    {0xfc, 0x8e},
    /****CISCTL & ANALOG****/
    {0xfe, 0x00},
    {0x87, 0x18},
    {0xee, 0x30},
    {0xd0, 0xb7},
    {0x03, 0x04},
    {0x04, 0x60},
    {0x05, 0x04},
    {0x06, 0x4c},
    {0x07, 0x04},//[13:8]vb
    {0x08, 0x72},//[7:0]vb
    {0x09, 0x00},
    {0x0a, 0x02},
    {0x0b, 0x00},
    {0x0c, 0x02},
    {0x0d, 0x04},
    {0x0e, 0x40},
    {0x12, 0xe2},
    {0x13, 0x16},
    {0x19, 0x0a},
    {0x21, 0x1c},
    {0x28, 0x0a},
    {0x29, 0x24},
    {0x2b, 0x04},
    {0x32, 0xf8},
    {0x37, 0x03},
    {0x39, 0x15},
    {0x43, 0x07},
    {0x44, 0x40},
    {0x46, 0x0b},
    {0x4b, 0x20},
    {0x4e, 0x08},
    {0x55, 0x20},
    {0x66, 0x05},
    {0x67, 0x05},
    {0x77, 0x01},
    {0x78, 0x00},
    {0x7c, 0x93},
    {0x8c, 0x12},
    {0x8d, 0x92},
    {0x90, 0x00},
    {0x41, 0x04},//VTS[13:8]
    {0x42, 0x65},//VTS[7:0]
    {0x9d, 0x10},
    {0xce, 0x7c},
    {0xd2, 0x41},
    {0xd3, 0xdc},
    {0xe6, 0x50},
    /*gain*/
    {0xb6,0xc0},
    {0xb0,0x70},
    {0xb1,0x01},
    {0xb2,0x00},
    {0xb3,0x00},
    {0xb4,0x00},
    {0xb8,0x01},
    {0xb9,0x00},
    /*blk*/
    {0x26,0x30},
    {0xfe,0x01},
    {0x40,0x23},
    {0x55,0x07},
    {0x60,0x40},
    {0xfe,0x04},
    {0x14,0x78},
    {0x15,0x78},
    {0x16,0x78},
    {0x17,0x78},
    /*window*/
    {0xfe,0x01},
    {0x92,0x00},
    {0x94,0x03},
    {0x95,0x04},
    {0x96,0x38},
    {0x97,0x07},
    {0x98,0x80},
    /*ISP*/
    {0xfe,0x01},
    {0x01,0x05},
    {0x02,0x89},
    {0x04,0x01},
    {0x07,0xa6},
    {0x08,0xa9},
    {0x09,0xa8},
    {0x0a,0xa7},
    {0x0b,0xff},
    {0x0c,0xff},
    {0x0f,0x00},
    {0x50,0x1c},
    {0x89,0x03},
    {0xfe,0x04},
    {0x28,0x86},
    {0x29,0x86},
    {0x2a,0x86},
    {0x2b,0x68},
    {0x2c,0x68},
    {0x2d,0x68},
    {0x2e,0x68},
    {0x2f,0x68},
    {0x30,0x4f},
    {0x31,0x68},
    {0x32,0x67},
    {0x33,0x66},
    {0x34,0x66},
    {0x35,0x66},
    {0x36,0x66},
    {0x37,0x66},
    {0x38,0x62},
    {0x39,0x62},
    {0x3a,0x62},
    {0x3b,0x62},
    {0x3c,0x62},
    {0x3d,0x62},
    {0x3e,0x62},
    {0x3f,0x62},
    /****DVP & MIPI****/
    {0xfe,0x01},
    {0x9a,0x06},
    {0xfe,0x00},
    {0x7b,0x2a},
    {0x23,0x2d},
    {0xfe,0x03},
    {0x01,0x20},
    {0x02,0x56},
    {0x03,0xb2},
    {0x12,0x80},
    {0x13,0x07},
    {0xfe,0x00},
    {0x3e,0x40},
    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_init_regs_1920_1080_40fps_mipi[] = {
        {0xfe, 0x80},
        {0xfe, 0x80},
        {0xfe, 0x80},
        {0xfe, 0x00},
        {0xf2, 0x00},
        {0xf3, 0x00},
        {0xf4, 0x36},
        {0xf5, 0xc0},
        {0xf6, 0x44},
        {0xf7, 0x01},
        {0xf8, 0x84},
        {0xf9, 0x40},
        {0xfc, 0x8e},
        {0xfe, 0x00},
        {0x87, 0x18},
        {0xee, 0x30},
        {0xd0, 0xb7},
        {0x03, 0x04},
        {0x04, 0x60},
        {0x05, 0x04},
        {0x06, 0x4c},
        {0x07, 0x00},
        {0x08, 0x11},
        {0x09, 0x00},
        {0x0a, 0x02},
        {0x0b, 0x00},
        {0x0c, 0x02},
        {0x0d, 0x04},
        {0x0e, 0x40},
        {0x12, 0xe2},
        {0x13, 0x16},
        {0x19, 0x0a},
        {0x21, 0x1c},
        {0x28, 0x0a},
        {0x29, 0x24},
        {0x2b, 0x04},
        {0x32, 0xf8},
        {0x37, 0x03},
        {0x39, 0x15},
        {0x43, 0x07},
        {0x44, 0x40},
        {0x46, 0x0b},
        {0x4b, 0x20},
        {0x4e, 0x08},
        {0x55, 0x20},
        {0x66, 0x05},
        {0x67, 0x05},
        {0x77, 0x01},
        {0x78, 0x00},
        {0x7c, 0x93},
        {0x8c, 0x12},
        {0x8d, 0x92},
        {0x90, 0x00},
        {0x41, 0x04},
        {0x42, 0x65},
        /* {0x41, 0x0b}, */
        /* {0x42, 0xbc}, */
        {0x9d, 0x10},
        {0xce, 0x7c},
        {0xd2, 0x41},
        {0xd3, 0xdc},
        {0xe6, 0x50},
        {0xb6, 0xc0},
        {0xb0, 0x70},
        {0xb1, 0x01},
        {0xb2, 0x00},
        {0xb3, 0x00},
        {0xb4, 0x00},
        {0xb8, 0x01},
        {0xb9, 0x00},
        {0x26, 0x30},
        {0xfe, 0x01},
        {0x40, 0x23},
        {0x55, 0x07},
        {0x60, 0x40},
        {0xfe, 0x04},
        {0x14, 0x78},
        {0x15, 0x78},
        {0x16, 0x78},
        {0x17, 0x78},
        {0xfe, 0x01},
        {0x92, 0x00},
        {0x94, 0x03},
        {0x95, 0x04},
        {0x96, 0x38},
        {0x97, 0x07},
        {0x98, 0x80},
        {0xfe, 0x01},
        {0x01, 0x05},
        {0x02, 0x89},
        {0x04, 0x01},
        {0x07, 0xa6},
        {0x08, 0xa9},
        {0x09, 0xa8},
        {0x0a, 0xa7},
        {0x0b, 0xff},
        {0x0c, 0xff},
        {0x0f, 0x00},
        {0x50, 0x1c},
        {0x89, 0x03},
        {0xfe, 0x04},
        {0x28, 0x86},
        {0x29, 0x86},
        {0x2a, 0x86},
        {0x2b, 0x68},
        {0x2c, 0x68},
        {0x2d, 0x68},
        {0x2e, 0x68},
        {0x2f, 0x68},
        {0x30, 0x4f},
        {0x31, 0x68},
        {0x32, 0x67},
        {0x33, 0x66},
        {0x34, 0x66},
        {0x35, 0x66},
        {0x36, 0x66},
        {0x37, 0x66},
        {0x38, 0x62},
        {0x39, 0x62},
        {0x3a, 0x62},
        {0x3b, 0x62},
        {0x3c, 0x62},
        {0x3d, 0x62},
        {0x3e, 0x62},
        {0x3f, 0x62},
        {0xfe, 0x01},
        {0x9a, 0x06},
        {0xfe, 0x00},
        {0x7b, 0x2a},
        {0x23, 0x2d},
        {0xfe, 0x03},
        {0x01, 0x27},
        {0x02, 0x5f},
        {0x03, 0xb6},
        {0x12, 0x80},
        {0x13, 0x07},
        {0x15, 0x10},
        {0xfe, 0x00},
        {0x3e, 0x91},
        {GC2053_REG_END, 0x00},	/* END MARKER */
};

#if 0
/*
 * the order of the jxf23_win_sizes is [full_resolution, preview_resolution].
 */
static struct tx_isp_sensor_win_setting gc2053_win_sizes[] = {
    /* 1920*1080 @ max 30fps dvp*/
    {
        .width = 1920,
        .height = 1080,
        .fps = 25 << 16 | 1,
        .mbus_code = V4L2_MBUS_FMT_SRGGB10_1X10,
        .colorspace = V4L2_COLORSPACE_SRGB,
        .regs = gc2053_init_regs_1920_1080_30fps_dvp,
    },
    /* 1920*1080 @ max 15fps dvp*/
    {
        .width = 1920,
        .height = 1080,
        .fps = 15 << 16 | 1,
        .mbus_code = V4L2_MBUS_FMT_SRGGB10_1X10,
        .colorspace = V4L2_COLORSPACE_SRGB,
        .regs = gc2053_init_regs_1920_1080_15fps_dvp,
    },
    /* 1920*1080 @ max 30fps mipi*/
    {
        .width = 1920,
        .height = 1080,
        .fps = 30 << 16 | 1,
        .mbus_code = V4L2_MBUS_FMT_SRGGB10_1X10,
        .colorspace = V4L2_COLORSPACE_SRGB,
        .regs = gc2053_init_regs_1920_1080_30fps_mipi,
    },
    /* 1920*1080 @ max 25fps mipi*/
    {
        .width = 1920,
        .height = 1080,
        .fps = 25 << 16 | 1,
        .mbus_code = V4L2_MBUS_FMT_SRGGB10_1X10,
        .colorspace = V4L2_COLORSPACE_SRGB,
        .regs = gc2053_init_regs_1920_1080_25fps_mipi,
    },
    /* 1920*1080 @ max 15fps mipi*/
    {
        .width = 1920,
        .height = 1080,
        .fps = 15 << 16 | 1,
        .mbus_code = V4L2_MBUS_FMT_SRGGB10_1X10,
        .colorspace = V4L2_COLORSPACE_SRGB,
        .regs = gc2053_init_regs_1920_1080_15fps_mipi,
    },
    /* 1920*1080 @ max 40fps mipi*/
    {
        .width = 1920,
        .height = 1080,
        .fps = 40 << 16 | 1,
        .mbus_code = V4L2_MBUS_FMT_SRGGB10_1X10,
        .colorspace = V4L2_COLORSPACE_SRGB,
        .regs = gc2053_init_regs_1920_1080_40fps_mipi,
    },
};

struct tx_isp_sensor_win_setting *wsize = &gc2053_win_sizes[5];
#endif

/*
 * the part of driver was fixed.
 */

static struct regval_list gc2053_stream_on_dvp[] = {
    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_stream_off_dvp[] = {
    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_stream_on_mipi[] = {
    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static struct regval_list gc2053_stream_off_mipi[] = {
    {GC2053_REG_END, 0x00},	/* END MARKER */
};

static int gc2053_write_array(struct GC2053_Platform *p, struct regval_list *vals)
{
    int ret;
    while (vals->reg_num != GC2053_REG_END) {
        if (vals->reg_num == GC2053_REG_DELAY) {
            p->delayMs(vals->value);
        } else {
            ret = p->sccbWriteReg(p->id, vals->reg_num, vals->value);
            if (ret < 0)
                return ret;
        }
        vals++;
    }

    return 0;
}

bool GC2053_ReadChipId(struct GC2053_Platform *p, uint16_t *chipId) {
    uint8_t chipIdH, chipIdL;
    int ret = 0;
    ret |= p->sccbReadReg(p->id, 0xf0, &chipIdH);
    ret |= p->sccbReadReg(p->id, 0xf1, &chipIdL);

    if (ret) {
        return false;
    }

    *chipId = (chipIdH << 8) | chipIdL;
    return true;
}

// NOTE: was commented out with #if 0
bool GC2053_SetExpo(struct GC2053_Platform *p, int value)
{
    int ret = 0;
    int it = value & 0xffff;
    int again = (value & 0xffff0000) >> 16;
    struct again_lut *val_lut = gc2053_again_lut;

    /*set sensor reg page*/
    ret = p->sccbWriteReg(p->id, 0xfe, 0x00);

    /* set vts */
    if (vtsn0 != vts0) {
        vts0 = vtsn0;
        ret += p->sccbWriteReg(p->id, 0x41, vtsn0);
    }
    if (vtsn1 != vts1) {
        vts1 = vtsn1;
        ret += p->sccbWriteReg(p->id, 0x42, vtsn1);
    }

    /*set integration time*/
    ret += p->sccbWriteReg(p->id, 0x04, it & 0xff);
    ret += p->sccbWriteReg(p->id, 0x03, (it & 0x3f00) >> 8);

    /*set analog gain*/
    ret += p->sccbWriteReg(p->id, 0xb4, val_lut[again].regb4);
    ret += p->sccbWriteReg(p->id, 0xb3, val_lut[again].regb3);
    ret += p->sccbWriteReg(p->id, 0xb8, val_lut[again].dpc);
    ret += p->sccbWriteReg(p->id, 0xb9, val_lut[again].blc);
    if (ret < 0) {
        return false;
    }

    return true;
}

// NOTE: was turned on with #if 1
bool GC2053_SetIntegrationTime(struct GC2053_Platform *p, int value)
{
    int ret = 0;

    ret = p->sccbWriteReg(p->id, 0x04, value & 0xff);
    ret += p->sccbWriteReg(p->id, 0x03, (value & 0x3f00) >> 8);
    if (ret < 0) {
        return false;
    }

    return true;
}

bool GC2053_SetAnalogGain(struct GC2053_Platform *p, int value)
{
    int ret = 0;
    struct again_lut *val_lut = gc2053_again_lut;

    ret = p->sccbWriteReg(p->id, 0xfe, 0x00);
    ret += p->sccbWriteReg(p->id, 0xb4, val_lut[value].regb4);
    ret += p->sccbWriteReg(p->id, 0xb3, val_lut[value].regb3);
    //ret += p->sccbWriteReg(p->id, 0xb2, val_lut[value].regb2);
    ret += p->sccbWriteReg(p->id, 0xb8, val_lut[value].dpc);
    ret += p->sccbWriteReg(p->id, 0xb9, val_lut[value].blc);
    if (ret < 0) {
        return false;
    }

    return true;
}

bool GC2053_SetDigitalGain(struct GC2053_Platform *p, int value)
{
    return false;
}

bool GC2053_GetBlackPedestal(struct GC2053_Platform *p, int *value)
{
    return false;
}

bool GC2053_Init(struct GC2053_Platform *p, enum GC2053_Mode mode) {
    struct regval_list *regs;

    switch (mode) {
    case GC2053_MODE_1920_1080_30FPS_DVP:
        regs = gc2053_init_regs_1920_1080_30fps_dvp;
        break;
    case GC2053_MODE_1920_1080_15FPS_DVP:
        regs = gc2053_init_regs_1920_1080_15fps_dvp;
        break;
    case GC2053_MODE_1920_1080_30FPS_MIPI:
        regs = gc2053_init_regs_1920_1080_30fps_mipi;
        break;
    case GC2053_MODE_1920_1080_25FPS_MIPI:
        regs = gc2053_init_regs_1920_1080_25fps_mipi;
        break;
    case GC2053_MODE_1920_1080_15FPS_MIPI:
        regs = gc2053_init_regs_1920_1080_15fps_mipi;
        break;
    case GC2053_MODE_1920_1080_40FPS_MIPI:
        regs = gc2053_init_regs_1920_1080_40fps_mipi;
        break;
    default:
        return false;
    }

    int ret = gc2053_write_array(p, regs);
    if (ret)
        return false;

    return true;
}

bool GC2053_SetStream(struct GC2053_Platform *p, enum GC2053_Mode mode, bool enable) {
    int ret = 0;

    switch (mode) {
    case GC2053_MODE_1920_1080_30FPS_DVP:
    case GC2053_MODE_1920_1080_15FPS_DVP:
        if (enable) {
            ret = gc2053_write_array(p, gc2053_stream_on_dvp);
        } else {
            ret = gc2053_write_array(p, gc2053_stream_off_dvp);
        }
        break;
    case GC2053_MODE_1920_1080_30FPS_MIPI:
    case GC2053_MODE_1920_1080_25FPS_MIPI:
    case GC2053_MODE_1920_1080_15FPS_MIPI:
    case GC2053_MODE_1920_1080_40FPS_MIPI:
        if (enable) {
            ret = gc2053_write_array(p, gc2053_stream_on_mipi);
        } else {
            ret = gc2053_write_array(p, gc2053_stream_off_mipi);
        }
        break;
    default:
        return false;
    }


    return ret == 0;
}


bool GC2053_SetFPS(struct GC2053_Platform *p, enum GC2053_Mode mode, int fps) {
    unsigned int wpclk = 0;
    unsigned short vts = 0;
    unsigned short hts = 0;
    unsigned int max_fps = 0;
    unsigned char tmp;
    unsigned int newformat = 0; //the format is 24.8
    int ret = 0;

    switch (mode) {
    case GC2053_MODE_1920_1080_30FPS_DVP:
        wpclk = GC2053_SUPPORT_30FPS_DVP_SCLK;
        max_fps = SENSOR_OUTPUT_MAX_FPS;
        break;
    case GC2053_MODE_1920_1080_15FPS_DVP:
        max_fps = TX_SENSOR_MAX_FPS_15;
        wpclk = GC2053_SUPPORT_15FPS_DVP_SCLK;
        break;
    case GC2053_MODE_1920_1080_30FPS_MIPI:
        max_fps = SENSOR_OUTPUT_MAX_FPS;
        wpclk = GC2053_SUPPORT_30FPS_MIPI_SCLK;
        break;
    case GC2053_MODE_1920_1080_25FPS_MIPI:
        max_fps = TX_SENSOR_MAX_FPS_25;
        wpclk = GC2053_SUPPORT_25FPS_MIPI_SCLK;
        break;
    case GC2053_MODE_1920_1080_15FPS_MIPI:
        max_fps = TX_SENSOR_MAX_FPS_15;
        wpclk = GC2053_SUPPORT_15FPS_MIPI_SCLK;
        break;
    case GC2053_MODE_1920_1080_40FPS_MIPI:
        max_fps = TX_SENSOR_MAX_FPS_40;
        wpclk = GC2053_SUPPORT_40FPS_MIPI_SCLK;
        break;
    default:
        return false;
    }

    /* the format of fps is 16/16. for example 25 << 16 | 2, the value is 25/2 fps. */
    newformat = (((fps >> 16) / (fps & 0xffff)) << 8) + ((((fps >> 16) % (fps & 0xffff)) << 8) / (fps & 0xffff));
    if (newformat > (max_fps << 8) || newformat < (SENSOR_OUTPUT_MIN_FPS << 8)) {
        return false;
    }
    ret = p->sccbWriteReg(p->id, 0xfe, 0x0);
    ret += p->sccbReadReg(p->id, 0x05, &tmp);
    hts = tmp;
    ret += p->sccbReadReg(p->id, 0x06, &tmp);
    if (ret < 0)
        return false;
    hts = ((hts << 8) + tmp) << 1;

    vts = wpclk * (fps & 0xffff) / hts / ((fps & 0xffff0000) >> 16);

    vtsn0 = (unsigned char)((vts & 0x3f00) >> 8);
    vtsn1 = (unsigned char)(vts & 0xff);

    ret = p->sccbWriteReg(p->id, 0x41, (unsigned char)((vts & 0x3f00) >> 8));
    ret += p->sccbWriteReg(p->id, 0x42, (unsigned char)(vts & 0xff));
    if (ret < 0)
        return false;

    return true;
}

bool GC2053_SetVFlip(struct GC2053_Platform *p, int enable)
{
    int ret = -1;
    unsigned char val = 0x0;

    ret = p->sccbWriteReg(p->id, 0xfe, 0x0);
    ret += p->sccbReadReg(p->id, 0x17, &val);

    if (enable & 0x2)
        val |= 0x02;
    else
        val &= 0xfd;

    ret += p->sccbWriteReg(p->id, 0x17, val);

    return ret == 0;
}
